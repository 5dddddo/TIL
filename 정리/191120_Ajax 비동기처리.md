# 191120_Axios/Ajax 비동기 처리

- HTTP -> Ajax(HTTP를 효과적으로 활용) -> WebSocket

## Axios

- 브라우저와 Node.js에서 사용할 수 있는 Promise 기반의 HTTP 클라이언트 라이브러리
  - 비동기 방식으로 HTTP 데이터 요청을 실행한다.
  - 내부적으로는 직접적으로 XMLHttpRequest를 다루지 않고 Ajax 호출을 보낼 수 있다.
- `Promise`(ES6)
  - 비동기 요청을 보내고 응답을 받았을 때, 그 응답 결과를 어떻게 처리하자고 약속(Promise)하는 것
  - `.then` : 응답이 정상적으로 왔을 경우 -> 이제 어떻게 처리할지 결정
  - `.catch` : 응답이 잘 안왔을 경우 -> 에러 처리!

<br>

## 1. Dog and Cat

### 1.1 Dog API

#### 1.1.1 설치

- Node.js

  ```
  $ npm install axios
  ```

### 1.2 [실습] Cat API

- [The Cat API](https://thecatapi.com/)

## 2. Like (GET 요청)

- `AJAX`

  - Asynchronous JavaScript and XML

  - 브라우저에서 웹페이지를 요청하거나 링크를 클릭하면 화면갱신(새로고침)이 일어났다. 이는 브라우저와 서버 간의 통신이 일어났다는 이야기다.

  - **JavaScript를 활용해서 비동기적으로 서버와 브라우저가 데이터를 교환할 수 있는 통신 방식**이다.

  - 페이지 전체를 다시 로드하는 것이 아니라,

     

    페이지에서 갱신이 필요한 일부분만 로드

    함으로써 빠른 퍼포먼스와 부드러운 화면 표시가 가능하다.

    - 사용자 경험(UX) 향상 + 서버 자원 이용 절감 -> 두 마리 토끼 다 잡기!

- `XHR(XMLHttpRequest)`

  - **브라우저는 XHR 객체를 이용해서 AJAX 요청을 생성하고 전송**한다.
  - 서버가 브라우저 요청에 응답 내용을 반환하면, 마찬가지로 XHR 객체가 그 결과를 처리한다.

### 2.1 좋아요 버튼을 부~드럽게

- 이전에 우리가 구현해 둔 장고 코드에서는 좋아요 버튼을 누르면 페이지 전환(요청)을 통해 좋아요 기능이 이루어짐
- 하지만 axios를 사용하면 페이지 전환 없이 좋아요 기능을 구현할 수 있다

#### 2.1.1 a 태그 삭제, i 태그 수정

1. <a> 의 url 태그 지우기~!
2. i 태그의 class에 class="like-button fas fa-heart" 추가
3. i 태그의 data-id 추가

``` html
 <p class="card-text">
        <!-- 사용자가 좋아요 누른 상태 -> 꽉찬 하트 -->
        <!-- data-id : JS가 데이터를 처리할 때 해당 요소가 어떤 article의 번호인지 구분하기 위해서 지정 -->
        {% if request.user in article.like_users.all %}
        <i data-id="{{article.pk }}" class="like-button fas fa-heart" style="color:crimson; cursor : pointer"></i>
        <!-- 사용자가 좋아요 안 누른 상태 -> 빈 하트-->
        {% else %}
        <i data-id="{{article.pk }}" class=" like-button fas fa-heart" style="color:black; cursor : pointer"></i>
        {% endif %}
        <br>
          {{article.like_users.all|length}}명이 이 글을 좋아합니다.
        <br>
```



#### 2.1.2 templates 수정

``` html
<!--templates/base.html-->

<!-- Axios -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
추가
```



- index.html에 추가

  ``` html
  <!--article/index.html-->
  ...
  <script>
    // 1. 모든 좋아요 버튼 가져오기
    const likeButtons = document.querySelectorAll('.like-button')
  
    // 2.forEach 함수 활용 ->  
    likeButtons.forEach(button => {
      button.addEventListener('click', function (event) {
        // event.target.classList, event.target.dataset.id
        // 1. data-id에 article.pk가 들어있음 -> 동적 라우팅 활용
        const articleId = event.target.dataset.id
        // 2. 해당 게시글의 좋아요 요청 보내기
        axios.get(`/articles/${articleId}/like`)
          .then(response => {
            //3. 응답 결과 확인
            console.log(response)
          }).catch(error => {
            console.log(error)
          })
      })
    })
  </script>
  ```

  

#### 2.1.3 View 수정

현재는 views.py 의 like 함수 로직에 의해 index.html 전체를 반환해줌

그럴필요 없다~!

like로직을 바꾸자 !

- 기존의 like 로직

--------------------

``` python
@login_required
def like(request, article_pk):
    #좋아요 누를 게시글 가져오기
    article = get_object_or_404(Article, pk= article_pk)
    # 현재 접속하고 있는 유저
    user = request.user

    # 현재 게시글 좋아요 누른 사람 목록에서,
    # 현재 접속한 유저가 있을 경우 -> 좋아요 취소
    if article.like_users.filter(pk=user.pk).exists():
        article.like_users.remove(user)
    #목록에 없을 경우 -> 좋아요 누르기
    else:
        article.like_users.add(user)
    context = {'liked':liked}
    return redirect('articles:index')
```

![1574226256927](C:\Users\student\AppData\Roaming\Typora\typora-user-images\1574226256927.png)

<br>

- 수정 후 like 로직

  - 좋아요 버튼의 `articleId`를 찾아서 좋아요 요청을 보냈을 때, View 로직에서 보내준 boolean 값에 따라 클래스를 지우거나 추가한다.

  - redirect 응답에 대한 결과로 `index.html`을 받는 것이 아니라, JSON 형태로 응답 결과를 반환 받는다.

    - 좋아요 취소 -> `liked = False`
    - 좋아요 -> `liked = True`

    ``` python
    from django.http import JsonResponse
    ...
    
    @login_required
    def like(request, article_pk):
        article = get_object_or_404(Article, pk= article_pk)
        user = request.user
        if article.like_users.filter(pk=user.pk).exists():
            article.like_users.remove(user)
            liked = False
            
        else:
            article.like_users.add(user)
            liked = True
        context = {'liked':liked}
        return JsonResponse(con)
    ```

    ![1574226530296](C:\Users\student\AppData\Roaming\Typora\typora-user-images\1574226530296.png)

    ``` javascript
    // index.html <script> 부분
    // 하트 색 변경하는 if문 추가
      likeButtons.forEach(button => {
        button.addEventListener('click', function (event) {
          const articleId = event.target.dataset.id
          axios.get(`/articles/${articleId}/like`)
            .then(response => {
              if (response.data.liked) {
                event.target.style.color = 'crimson'
              }
              else{
                event.target.style.color = 'black'
              }
            }).catch(error => {
              console.log(error)
            })
        })
      })
    ```

    ![1574226683543](C:\Users\student\AppData\Roaming\Typora\typora-user-images\1574226683543.png)

### 2.2 좋아요 Count 비동기처리

#### 2.2.1 View

``` python
@login_required
def like(request, article_pk):
    ...
	context = {'liked':liked,
               'count':article.like_users.count(),}
```



#### 2.2.2 Templates

- 구분을 위해 span 의 아이디를 지정

  ``` html
  <!-- _article.html -->
  ...
      <span id="like-count-{{article.pk}}">
        {{article.like_users.all|length}}
      </span>명이 좋아요
  ...
  ```

- 알맞은 id 값을 가진 span 태그를 선택해서,

  사용자가 좋아요를 누를 때마다 response.data.count 값으로 갱신시킨다.

  ``` javascript
  // index.html
  likeButtons.forEach(button => {
      button.addEventListener('click', function (event) {
        // event.target.classList, event.target.dataset.id
        // 1. data-id에 article.pk가 들어있음 -> 동적 라우팅 활용
        const articleId = event.target.dataset.id
        // 2. 해당 게시글의 좋아요 요청 보내기
        axios.get(`/articles/${articleId}/like`)
          .then(response => {
            //3. 응답 결과 확인
            console.log(response.data)
            // 알맞은 id 값을 가진 span 태그를 선택해서,
            // 사용자가 좋아요를 누를 때마다 response.data.count 값으로 갱신시킨다.
            document.querySelector(`#like-count-${articleId}`).innerText = response.data.count
            if (response.data.liked) {
              event.target.style.color = 'crimson'
            } else {
              event.target.style.color = 'black'
            }
          }).catch(error => {
            console.log(error)
          })
      })
  ```

---------

## 3. POST 요청으로 바꾸자

- axios.post
- url 마지막에 반드시 '/' 추가해야 함

``` javascript
<!-- index.html -->
button.addEventListener('click', function (event) {
  const articleId = event.target.dataset.id
  axios.post(`/articles/${articleId}/like/`)
// url 마지막에 반드시 '/' 추가해야 함
```

- **Forbidden Error**

  - 사용자 인증 필요

  ![1574228795654](C:\Users\student\AppData\Roaming\Typora\typora-user-images\1574228795654.png)

  - POST 요청 전에 default로 인증 값 설정

    ``` javascript
     axios.defaults.xsrfCookieName = 'csrftoken'
    axios.defaults.xsrfHeaderName = 'X-CSRFToken'
    
    axios.post(`/articles/${articleId}/like/`)
    ...
    ```

    

- ajax 요청이면 like 수행

  아니면, 404 Error 발생시키기

``` python
from django.http import JsonResponse, HttpResponseBadRequest

@login_required
def like(request, article_pk):
    if request.is_ajax():
        article = get_object_or_404(Article, pk= article_pk)
   		...
        return JsonResponse(context)
    else:
        return HttpResponseBadRequest
```

- 

![1574230243383](C:\Users\student\AppData\Roaming\Typora\typora-user-images\1574230243383.png)

- ajax는 XHR 객체를 통해 요청하고,  XHR 객체를 반환 받음

  - 현재는 XHR 객체가 없음
  -  XHR 객체를 header에 담아서 보내주자

  ``` javascript
  // index.html
  ...
  	button.addEventListener('click', function (event) { 
      // django가 Ajax 요청을 구분하게 하기 위해서 XHR 객체를 담아서 보내줌
  
        axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
  ```



- 비회원이 좋아요를 누르면

  ![1574230495501](C:\Users\student\AppData\Roaming\Typora\typora-user-images\1574230495501.png)

  한 문제점 발생!

  ``` javascript
  // 로그인 된 유저만 좋아요 기능 사용할 수 있도록 조건문 추가
  {% if user.is_authenticated %}
      axios.post(`/articles/${articleId}/like/`)
        .then(response => {
          //3. 응답 결과 확인
          console.log(response.data)
          // 알맞은 id 값을 가진 span 태그를 선택해서,
          // 사용자가 좋아요를 누를 때마다 response.data.count 값으로 갱신시킨다.
          document.querySelector(`#like-count-${articleId}`).innerText = response.data.count
          if (response.data.liked) {
            event.target.style.color = 'crimson'
          } else {
            event.target.style.color = 'black'
          }
        }).catch(error => {
          console.log(error)
        })
    {% else %}
      alert('로그인을 해야 기능을 사용할 수 있습니다.')
    {% endif %}
  ```

  ![1574230739585](C:\Users\student\AppData\Roaming\Typora\typora-user-images\1574230739585.png)

